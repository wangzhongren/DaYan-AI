<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>大衍 AI · 后台推演系统</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        body { background: #f4f1ea; font-family: serif; display: flex; justify-content: center; padding: 40px; }
        .card { max-width: 600px; width: 100%; background: white; padding: 30px; border: 1px solid #dcdcdc; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        h1 { text-align: center; color: #1a1a1a; border-bottom: 1px solid #333; padding-bottom: 10px; }
        textarea { width: 100%; padding: 10px; margin: 20px 0; border: 1px solid #ccc; box-sizing: border-box; font-size: 16px; }
        button { width: 100%; padding: 15px; background: #1a1a1a; color: white; border: none; cursor: pointer; font-size: 18px; }
        button:disabled { background: #999; }
        #output { margin-top: 30px; line-height: 1.8; color: #333; min-height: 100px; border-top: 1px dashed #ccc; padding-top: 20px; }
        .status { font-size: 12px; color: #888; text-align: center; margin-top: 10px; }
    </style>
</head>
<body>
    <div class="card">
        <h1>大衍推演</h1>
        <div class="status">后台已配置：{{ config_model }}</div>
        <textarea id="userInput" rows="5" placeholder="请描述当下的环境、局势或你的困惑..."></textarea>
        <button id="btn" onclick="run()">开启推演</button>
        <div id="output"></div>
    </div>

    <script>
        // 配置 marked（可选：关闭不安全 HTML）
        marked.setOptions({ sanitize: true }); // 旧版用 sanitize，新版建议用 DOMPurify（见下方说明）

        async function run() {
            const input = document.getElementById('userInput').value;
            const output = document.getElementById('output');
            const btn = document.getElementById('btn');
            
            if (!input) return alert("请输入语境");

            output.innerHTML = "正在感应... ";
            btn.disabled = true;

            let fullText = ""; // 用于累积完整 Markdown

            try {
                const response = await fetch('/deduce', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ content: input })
                });

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                output.innerHTML = "";

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    
                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n');
                    
                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const dataStr = line.slice(6).trim();
                            if (dataStr === '[DONE]') break;
                            try {
                                const json = JSON.parse(dataStr);
                                const text = json.content || "";
                                fullText += text;
                                // 实时渲染 Markdown 为 HTML
                                output.innerHTML = marked.parse(fullText);
                                // 滚动到底部（可选）
                                output.scrollTop = output.scrollHeight;
                            } catch (e) {
                                console.error("Parse error:", e);
                            }
                        }
                    }
                }
            } catch (e) {
                output.innerHTML = "<p style='color:red;'>推演中断，请检查后端连接。</p>";
            } finally {
                btn.disabled = false;
            }
        }
    </script>
</body>
</html>